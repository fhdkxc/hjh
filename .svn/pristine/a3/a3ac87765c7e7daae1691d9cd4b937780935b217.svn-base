<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<script type="text/javascript" src="/resources/js/commonFunction.js"></script>
    
<script>
let dclzRes;

// 출결 정보 get
const getAllDclz = function(){
	$.ajax({
		url :"/dclz/getAllDclz",
	    type:"post",
	    contentType:"application/json",
	    dataType:"json",
	    async: false,
	    beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		},
		success : function(res) {
			console.log("getAllDclz:",res);
			dclzRes = res;
		},
		 error:function(request,status,error){
			 alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
		 }
	})
}

// 출석 버튼
const insertDclz = function(clasStdntCode){
	$.ajax({
		url :"/dclz/insertDclz",
	    type:"post",
	    data:clasStdntCode,
	    contentType:"application/json",
	    dataType:"json",
	    beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		},
		success : function(res) {
			console.log("insertDclz:",res);
		},
		 error:function(request,status,error){
			 alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
		 }
	})
}

// 출결 정보 테이블 리스트로 생성
const makeTbodyStr = function(dclzRes){
	let str = "";
	
	dclzRes.forEach(function(std,index1){

		// 결석
		if(std.dayList.length == 0){
			
			str += `<tr onclick ="extendTr('\${std.clasStdntCode}_noData')" class = "d-tr">
					<td>\${std.clasInNo}</td>
					<td>\${std.mberNm}</td>
					<td>??</td>
					<td>출석 없음</td>
					<td>출석 없음</td>
					<td>결석</td>
					
					<sec:authorize access ="hasRole('A01002')">
					<td></td>
					<td style ="text-align:center;">
						<button class = "d-btn-blue" style ="width:100%; max-width:150px;"
						onclick ="changeStatus('\${std.clasStdntCode}',null)">변경</button>
					</td>
					</sec:authorize>
					
					</tr>`
		}
		
		std.dayList.forEach(function(day,index2){

			day.timeList.forEach(function(time,index3){
				str += `<tr onclick ="extendTr('\${std.clasStdntCode}_\${day.atendDe}')" class = "d-tr">`;
				if(index3 == 0){
					str += `<td>\${std.clasInNo}</td>
							<td>\${std.mberNm}</td>
							<td>\${day.atendDe}</td>
							<td>\${day.timeList[0].dclzProcessTime}</td>
							<td>\${day.timeList[day.timeList.length-1].dclzProcessTime}</td>
							<td>\${day.dclzCmmnNm}</td>
							
							<sec:authorize access ="hasRole('A01002')">
							<td></td>
							<td style ="text-align:center;">
								<button class = "d-btn-blue" style ="width:100%; max-width:150px;"
								onclick ="changeStatus('\${std.clasStdntCode}','\${day.atendDe}')">변경</button>
							</td>
							</sec:authorize>
							
							</tr>`
							
				}
				str += `<tr class ="d-tr \${std.clasStdntCode}_\${day.atendDe}" style ="display:none;">
						<td></td>
						<td></td>
						<td>\${index3+1}</td>
						<td>\${time.dclzProcessTime}</td>
						<td></td>
						<td></td>
						
						<sec:authorize access ="hasRole('A01002')">
						<td></td>
						<td></td>
						</sec:authorize>
						
						</tr>`;
			})
		})
	})
	
	return str;
}

const extendTr = function(trCl){
	let targets = document.querySelectorAll("."+trCl);
	
	targets.forEach(function(target){
		if(target.style.display == "none"){
			target.style.display ="table-row";
		}else{
			target.style.display ="none";
		}
	})
}

const changeStatus = function(clasStdntCode, atendDe){
	event.stopPropagation();
	console.log("clasStdntCode:"+clasStdntCode+" atendDe:"+atendDe);
}


window.onload = function(){
	getAllDclz();
	
	let str = makeTbodyStr(dclzRes);
	document.querySelector("#dclzListTb tbody").innerHTML = str;
}
</script>
    
<button onclick = "insertDclz('CS10000001')">출석</button>

<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
	<div class="product-status mg-b-15">
		<div class="container-fluid">
			<div class="row">
				<div class="product-status-wrap" style="position: relative;">
					<div class="add-product">
					</div>
					<div class="asset-inner">
						<table id ="dclzListTb">
							<thead>
								<tr>
									<th>학급 번호</th>
									<th>학생 명</th>
									<th>날짜</th>
									<th>등교 시간</th>
									<th>하교 시간</th>
									<th>출결 처리</th>
									
									<sec:authorize access ="hasRole('A01002')">
									<th>제출 서류</th>
									<th style = "text-align:center;">처리 상태 변경</th>
									</sec:authorize>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="100%" style="text-align: center;">등록된 출석이 없습니다..</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

