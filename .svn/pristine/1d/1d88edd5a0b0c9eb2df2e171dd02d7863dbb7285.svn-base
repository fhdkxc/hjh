<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<style>
h3{
	font-size: 2.2rem;
	text-align: center;
	margin-top: 60px;
	backdrop-filter: blur(4px);
	background-color: rgba(255, 255, 255, 1);
	border-radius: 50px;
	box-shadow: 35px 35px 68px 0px rgba(145, 192, 255, 0.5), inset -8px -8px 16px 0px rgba(145, 192, 255, 0.6), inset 0px 11px 28px 0px rgb(255, 255, 255);
	width: 370px;
	padding-top: 35px;
	padding-bottom: 35px;
	margin: auto;
	margin-top: 50px;
	margin-bottom: 40px;
}
.form-control {
	text-align: center;
}

</style>
<script>
	const header = "${_csrf.headerName}";
	const token = "${_csrf.token}";
	

	window.onload = function() {
    var schulCode = "${param.schulCode}";
	var clasCode = "${param.clasCode}"; 
	
    //var currentPage = "${param.currentPage}";

	//학생/학부모 탭 구분 변수
	const stdntTab = document.querySelector("#stdntTab");			//학생 탭
	const stdntTabDiv = document.querySelector("#stdntTabDiv");		//학생 탭 출력 div

	let html = "";					//목록 초기화
	let currentPage = "1";			//첫 시작 페이지 선언
	let keyword = "";				//키워드 선언
	

	//탭 구분 시작//
	//탭 구분 끝

	// 검색어가 없을 때 ""로 설정
	//if (keyword == null || keyword == undefined) {	keyword = ""; }
	

	//학생 구성원 목록 불러오는 Ajax(classStudListAjax) 시작//
	const classStudListAjax = function(keyword){
		let data = {
				"schulCode":schulCode,
				"clasCode":clasCode,
				"currentPage" : currentPage
			}

		console.log("data",data);

		$.ajax({
				url: "/class/classStudListAjax",
				contentType:"application/json;charset=utf-8",
				data:JSON.stringify(data),
				type : "post",
				dataType:"json",
				beforeSend:function(xhr){
						xhr.setRequestHeader(header,token);
					},
				success:function(result){				
					const classStudMemListBody = document.querySelector("#classStudMemListBody");
					let html = "";	//목록 초기화
					$.each(result.content, function(idx, clasStdntVO){
						html += `<tr> 
								<td><input type="checkbox" class="individual-checkbox" onchange="updateSelectAll()" value="\${clasStdntVO.mberId}" style="display:none;" /></td>
								<td>\${clasStdntVO.rnum}</td>
								<td href="#PrimaryModalhdbgcl" data-toggle="modal" data-target="#PrimaryModalhdbgcl" onclick=stdntDetail('\${clasStdntVO.mberId}') onmouseover="this.style.cursor='pointer'">\${clasStdntVO.mberNm}</td>
								<td>\${clasStdntVO.clasInNo}</td>
								<td>\${clasStdntVO.cmmnStdntClsfNm}</td>
								<td>\${clasStdntVO.cmmnClasPsitnSttusNm}</td>
								<td>\${dateFormat(clasStdntVO.clasStdntJoinDate)}</td>
								</tr>`;
					}); //반복문 끝
					classStudMemListBody.innerHTML = html;
				}
			}); 
	}//학생 구성원 목록 불러오는 Ajax(classStudListAjax) 끝//
	classStudListAjax(keyword);		//학생 목록 불러오기

	//학부모 구성원 목록 불러오는 Ajax(classParentListAjax) 시작//
	const classParentListAjax = function(keyword){

		let data = {
				"clasCode":clasCode,
				"currentPage" : currentPage
			}

		console.log("data",data);

		$.ajax({
				url: "/class/classParentListAjax",
				contentType:"application/json;charset=utf-8",
				data:JSON.stringify(data),
				type : "post",
				dataType:"json",
				beforeSend:function(xhr){
						xhr.setRequestHeader(header,token);
					},
				success:function(result){				
					const classPrentMemListBody = document.querySelector("#classPrentMemListBody");
					let html = "";	//목록 초기화
					$.each(result.content, function(idx, chldrnClasVO){
						html += `<tr> 
								<td>\${chldrnClasVO.rnum}</td>
								<td href="#PrimaryModalhdbgcl" data-toggle="modal" data-target="#PrimaryModalhdbgcl" onclick=stdntDetail('\${chldrnClasVO.mberId}') onmouseover="this.style.cursor='pointer'">\${chldrnClasVO.stdnprntNm}</td>
								<td>\${chldrnClasVO.stdntNm}</td>
								<td>\${chldrnClasVO.cmmnDetailNm}</td>
								</tr>`;
					}); //반복문 끝
					classPrentMemListBody.innerHTML = html;
				}
			}); 
	}//학부모 구성원 목록 불러오는 Ajax(classParentListAjax) 끝//
	classParentListAjax(keyword);		//학생 목록 불러오기



// 체크된 체크박스의 ID 값을 가져오는 함수
function getSelectedIds() {
        var mberIds = [];
        // 모든 체크박스 요소에 대해 반복
        var checkboxes = document.querySelectorAll(".individual-checkbox:checked");
		console.log("체킁:",checkboxes);
		for(let i=0; i< checkboxes.length; i++){
			mberIds.push(checkboxes[i].value);
		}
		return mberIds;
    }

// 초대버튼 클릭 시 체크박스 보이기
document.getElementById("sendMailChkBtn").addEventListener("click", function() {
        // 모든 숨겨진 체크박스 요소를 가져옴
		document.getElementById("sendMailChkBtn").style.display="none";											 //초대하기 버튼 가리기
		document.getElementById("sendMailBtn").style.display="block";											 //전송버튼 보이기
		document.getElementById("cancleBtn").style.display="block";												 //취소하기 버튼 보이기
        document.getElementById("selectAll").style.display = "block";											 //tr요소 보이기
		document.querySelectorAll('.individual-checkbox').forEach(checkbox => checkbox.style.display = "block"); //td요소 보이기
    });
   
// 초대버튼 -> 취소버튼
document.getElementById("cancleBtn").addEventListener("click", function() {
	document.getElementById("sendMailBtn").style.display="none";											 //전송버튼 가리기
	document.getElementById("cancleBtn").style.display="none";												 //취소하기 버튼 가리기
	document.getElementById("sendMailChkBtn").style.display="block";										 //초대하기 버튼 보이기
	document.getElementById("selectAll").style.display = "none";											 //tr요소 가리기
	document.querySelectorAll('.individual-checkbox').forEach(checkbox => checkbox.style.display = "none"); //td요소 가리기
});
	

 // 초대코드 메일 보내기! (버튼)
 document.getElementById("sendMailBtn").addEventListener("click", function() {
        var mberIds = getSelectedIds();

		if(mberIds == "" || mberIds == null || !mberIds){
			Swal.fire({
				  icon : "warning",
			      title: "초대할 학부모의 자녀를 선택해주세요."
			});
			return;
		}
		let data = {
			"mberIds":mberIds,
			"clasCode":clasCode
			}
			console.log("data::",data);

		//초대코드 보내기 Ajax 시작
		$.ajax({
			type:"post",
			url:"/class/classMailSend",
			data:JSON.stringify(data),
			contentType:"application/json;charset=utf-8",
			dataType:"text",
			beforeSend:function(xhr){
						xhr.setRequestHeader(header,token);
					},
			success:function(result){
				console.log("result",result);
				Swal.fire({
				  icon : "success",
			      title: "전송이 완료됐습니다."
			    });
			}			
		});//초대코드 보내기 Ajax 끝
		
		document.getElementById("sendMailChkBtn").style.display="block";		//초대하기 버튼 보이기
		document.getElementById("sendMailBtn").style.display="none";			//전송버튼 가리기
		document.getElementById("cancleBtn").style.display="none";				//취소하기 버튼 가리기
		document.getElementById("selectAll").style.display = "none";			//tr요소 가리기
		document.querySelectorAll('.individual-checkbox').forEach(checkbox => checkbox.style.display = "none"); //td요소 가리기
    }); //초대코드 메일보내기 끝


	//수정 버튼
	document.getElementById("updateBtn").addEventListener("click", function() {

	}); //수정버튼 끝


}//window.onload끝

//상세정보 가져오는 Ajax 시작//
function stdntDetail(mberId){
	let data = {
		"mberId":mberId
	}
	console.log("mberId",mberId);
	//회원 정보 가져오는 ajax시작
	$.ajax({
		type:"post",
		url:"/class/classMberDetailAjax",
		data:JSON.stringify(data), //얘를 스트링으로 바꿔서 보내면
		dataType:"json",			//컨트롤러가 보내는값이 json
		contentType:"application/json;charset=utf-8", //받는애한테 형식이 제이슨이라고 알려줘
		beforeSend:function(xhr){
						xhr.setRequestHeader(header,token);
					},
		success:function(result){
			console.log("result", result);

			//상세 정보 모달 출력 시작
			document.querySelector("#studMberImage").src = "/upload/profile/"+result.mberImage;
			document.querySelector("#studMberNm").value = result.mberNm;		//이름
			document.querySelector("#studMberId").value = result.mberId;		//아이디
			document.querySelector("#studMberEmail").value = result.mberEmail;	//이메일
			document.querySelector("#studBirthDate").value = result.birthDate;		//생년월일
			document.querySelector("#studMoblphonNo").value = result.moblphonNo;		//핸드폰번호
			document.querySelector("#studZip").value = result.zip;				//우편번호
			document.querySelector("#studMberAdres").value = result.mberAdres;	//상세주소
		},
		error: function (xhr, status, error) {
			console.log("code: " + xhr.status)
			console.log("message: " + xhr.responseText)
			console.log("error: " + error);
		}

	}) //회원 정보 가져오는 ajax끝
}//상세정보 가져오는 Ajax 끝//
    

//타임스탬프 값 바꾸기
function dateFormat(date){
	   var selectDate = new Date(date);
	   var d = selectDate.getDate();
	   var m = selectDate.getMonth() + 1;
	   var y = selectDate.getFullYear();
	   
	   if(m < 10) m = "0" + m;
	   if(d < 10) d = "0" + d;
	   
	   return y + "-" + m + "-" + d; 
	} 

// 체크박스 전체 선택
function selectAll(selectAll) {
  const checkboxes = document.querySelectorAll('.individual-checkbox');	//개별 체크박스 요소 모두 선택
  checkboxes.forEach(checkbox => {										// 선택된걸로 변경
    checkbox.checked = selectAll.checked;
  });
}

// 체크박스 개별 선택
function updateSelectAll() {
  const checkboxes = document.querySelectorAll('.individual-checkbox'); //개별 체크박스 요소 모두 선택
  const selectAllCheckbox = document.getElementById('selectAll');		//전체 선택 체크박스 요소 가져오기
  
  let allChecked = true;												//체크박스 선택되었나 확인 초기값true
  checkboxes.forEach(checkbox => {										//모든 개별 체크박스 상태 확인
    if (!checkbox.checked) {											//선택 안 한 체크박스 상태 false로 변경
      allChecked = false;
    }
  });
  
  selectAllCheckbox.checked = allChecked;	//상태 업데이트
}



</script>
<!--구성원 목록 탭 시작 -->
<div class="admintab-area mg-b-15">
	<div class="container-fluid">
		<div class="row">
			<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
				<div class="tab-content-details shadow-reset">
					<h3>
						<img src="/resources/images/classRoom/classList1.png" style="width:50px; display:inline-block; vertical-align:middel;">
						구성원 관리 목록
						<img src="/resources/images/classRoom/classList2.png" style="width:50px; display:inline-block; vertical-align:middel;">		
					</h3>
				</div>
			</div>
		</div>
		<div class="row">
			<!-- 검색 -->
			<div class="col-md-2 text-right">
				<!-- text-right를 사용하여 오른쪽 정렬 -->
				<div class="breadcome-heading">
					<form role="search" class="sr-input-func">
						<input type="text" name="keyword" id="keyword" placeholder="Search..." class="search-int form-control"> <a href="#" id="btnSearch"><i class="fa fa-search"></i></a>
					</form>
				</div>
			</div>
			<!-- 검색 끝 -->
			<!--버튼 시작-->
			<div class="col-md-10 text-right">
				<button type="button" id="sendMailChkBtn" class="btn btn-custon-rounded-two btn-primary">초대하기</button>
				<button type="button" id="sendMailBtn" class="btn btn-custon-rounded-two btn-primary" style="display:none;">메일발송</button>
				<button type="button" id="cancleBtn" class="btn btn-custon-rounded-two btn-primary" style="display:none;">취소</button>
				<button type="button" id="updateBtn" class="btn btn-custon-rounded-two btn-primary">수정</button>
			</div>
			<!--버튼 끝-->
				</div>
				<div class="row">
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12" style="width: 100%;">
						<div class="admintab-wrap edu-tab1 mg-t-30">
							<ul class="nav nav-tabs custom-menu-wrap custon-tab-menu-style1">
								<li class="active"><a data-toggle="tab" id="stdntTab" href="#stdntTabDiv" aria-expanded="true"><span class="edu-icon edu-analytics tab-custon-ic"></span>학생</a>
								</li>
								<li class=""><a data-toggle="tab" id="parentTab" href="#parentTabDiv" aria-expanded="false"><span class="edu-icon edu-analytics-arrow tab-custon-ic"></span>학부모</a>
								</li>
					</ul>
					<div class="tab-content">
						<!-- 학생 탭 시작 -->
						<div id="stdntTabDiv" class="tab-pane flipInX custon-tab-style1 active">
							<table class="table">
								<thead>
									<tr>
										<th><input type="checkbox" id="selectAll" onclick="selectAll(this)" style="display: none;"/></th>
										<th>순번</th>
										<th>이름</th>
										<th>학급번호</th>
										<th>임원</th>
										<th>상태</th>
										<th>가입일</th>
										<th></th>
									</tr>
								</thead>
								<tbody id="classStudMemListBody">
								</tbody>
							</table>
						</div>
						<!-- 학생 탭 끝 -->
						<!-- 학부모 탭 시작-->
						<div id="parentTabDiv" class="tab-pane flipInX custon-tab-style1">
							<table class="table">
								<thead>
									<tr>
										<th>순번</th>
										<th>학부모 명</th>
										<th>학생 명</th>
										<th>가족관계</th>
									</tr>
								</thead>
								<tbody id="classPrentMemListBody">
								</tbody>
							</table>
						</div>
						<!-- 학부모 탭 끝-->
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!--구성원 목록 탭 끝 -->

<!-- 학생 정보 모달 띄우기 -->
<div id="PrimaryModalhdbgcl" class="modal modal-edu-general default-popup-PrimaryModal fade in" role="dialog" style="display: none; padding-right: 17px;">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header header-color-modal bg-color-1">
				<h4 class="modal-title">학생 정보</h4>
				<div class="modal-close-area modal-close-df">
					<a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
				</div>
			</div>
			<div class="modal-body">
				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<img src="" id="studMberImage" name="studMberImage" style="width: 300px; height: 300px;">
						</div>
					</div>
					<div class="col-md-12">
						<div class="form-group" style="width:50%;float:left;">
							<label for="">이름</label> 
							<input type="text" class="form-control is-valid" id="studMberNm" name="studMberNm" readonly />
						</div>
						<div class="form-group" style="width:50%;float:left;">
							<label for="">아이디</label> 
							<input type="text" class="form-control is-valid" id="studMberId" name="studMberId" readonly />
						</div>
					</div>
					<div class="col-md-12">
						<div class="form-group" style="width:50%;float:left;">
							<label for="">이메일</label> 
							<input type="text" class="form-control is-valid" id="studMberEmail" name="studMberEmail" readonly />
						</div>
						<div class="form-group" style="width:50%;float:left;">
							<label for="">생년월일</label> 
							<input type="text" class="form-control is-valid" id="studBirthDate" name="studBirthDate" readonly />
						</div>
					</div>
					<div class="col-md-12">
						<div class="form-group" style="width:50%;float:left;">
							<label for="">전화번호</label> 
							<input type="text" class="form-control is-valid" id="studMoblphonNo" name="studMoblphonNo" readonly />
						</div>
						<div class="form-group" style="width:50%;float:left;">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
							<label for="">우편번호</label> 
							<input type="text" class="form-control is-valid" id="studZip" name="studZip" readonly />
						</div>
					</div>
					<div class="col-md-12">
						<div class="form-group">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
							<label for="">상세주소</label> 
							<input type="text" class="form-control is-valid" id="studMberAdres" name="studMberAdres" readonly />
						</div>
					</div>
						<div class="modal-footer">
							<a data-dismiss="modal" href="#">닫기</a>
						</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!--학생 정보 모달 띄우기 끝 -->