package kr.or.ddit.school.service.impl;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import kr.or.ddit.school.mapper.AfterSchoolMapper;
import kr.or.ddit.school.service.AfterSchoolService;
import kr.or.ddit.vo.AschaVO;
import kr.or.ddit.vo.AschaWeekPlanVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class AfterSchoolServiceImpl implements AfterSchoolService {
	
	@Autowired
	AfterSchoolMapper afterSchoolMapper;

	// 방과후학교 전체 리스트
	@Override
	public List<AschaVO> afterSchoolList(Map<String, Object> map) {
		return this.afterSchoolMapper.afterSchoolList(map);
	}
	
	// 전체 방과후학교 수
	@Override
	public int getTotalAfterSchool(Map<String, Object> map) {
		return this.afterSchoolMapper.getTotalAfterSchool(map);
	}

	// 방과후학교 상세
	@Override
	public List<AschaVO> afterSchoolDetail(AschaVO aschaVO) {
		log.info("afterSchoolDetail->service "+aschaVO);
		
		return this.afterSchoolMapper.afterSchoolDetail(aschaVO);
	}

	// 방과후학교 생성
	@Override
	public int afterSchoolCreate(AschaVO aschaVO) {
		// 방과후학교 코드 설정
		// db에서 가장 큰 코드 가지고 오기
		/*
		AschaVO(aschaCode=null, aschaNm=테스트임니다, aschaDetailCn=1, aschaAtnlcCt=2, aschaAceptncPsncpa=3, aschaAtnlcBgnde=Sat Mar 09 00:00:00 KST 2024, aschaAtnlcEndde=Fri Mar 22 00:00:00 KST 2024, schulCode=7581092, mberId=null, cmmnDetailCode=null, cmmnAtnlcNm=null, mberNm=null, schulNm=null, cmmnGrade=null, clasNm=null, clasInNo=null, 
		aschaWeekPlanVOList=[
			AschaWeekPlanVO(aschaWeekPlanCode=null, aschaWeek=1주, aschaWeekPlanCn=a, aschaCode=null), 
			AschaWeekPlanVO(aschaWeekPlanCode=null, aschaWeek=2주, aschaWeekPlanCn=b, aschaCode=null), 
			AschaWeekPlanVO(aschaWeekPlanCode=null, aschaWeek=3주, aschaWeekPlanCn=c, aschaCode=null), 
			AschaWeekPlanVO(aschaWeekPlanCode=null, aschaWeek=4주, aschaWeekPlanCn=d, aschaCode=null)], 
		atnlcReqstVOList=null)
		 */
		log.info("afterSchoolCreate(serviceImpl) -> aschaVO : " + aschaVO);
		
		int maxAschaSeq = afterSchoolMapper.getMaxAschaSeq(aschaVO.getSchulCode());
		//maxSeq ->18
		log.info("maxSeq ->" +maxAschaSeq);
		
		// 일련번호 생성
		int nextAschaSeq = maxAschaSeq +1;
		
		// 현재연도 추출
		LocalDate now = LocalDate.now();
		//nowTime : 2024
		log.info("nowTime : "+now.getYear());
		
		// 일련번호를 포함한 방과후학교 코드 설정(SCHUL_CODE+생성연도+일련번호)
	 	String nextAschaCode = aschaVO.getSchulCode() + now.getYear() +String.format("%04d", nextAschaSeq);
		
		// 생성된 방과후학교 코드 설정
		aschaVO.setAschaCode(nextAschaCode);
		// 아이디 지정(수정필요함)
		aschaVO.setMberId("758109210002");
		aschaVO.setCmmnDetailCode("A10001");	// 신청진행중 코드로 고정함.
		
		int result = this.afterSchoolMapper.afterSchoolCreate(aschaVO);
		log.info("afterSchoolCreate->result : " + result);
		
		// ASCHA_WEEK_PLAN 테이블에 insert
		List<AschaWeekPlanVO> aschaWeekPlanVOList = aschaVO.getAschaWeekPlanVOList();
		List<AschaWeekPlanVO> aschaWeekPlanVOList2 = new ArrayList<AschaWeekPlanVO>();

		// 일련번호 생성(방과후학교코드 + 01)
		int code = 0;
		
		for(AschaWeekPlanVO aschaWeekPlanVO : aschaWeekPlanVOList) {
			aschaWeekPlanVO.setAschaCode(aschaVO.getAschaCode());
			// 방과후코드 1씩 증가
			code++;
			String codeNum = aschaVO.getAschaCode() + String.format("%02d", code);
			//codeNum : 75810922024001902
			log.info("codeNum : "+codeNum);
			
			// 생성한 일련번호 등록
			aschaWeekPlanVO.setAschaWeekPlanCode(codeNum);
			//aschaWeekPlanVO ->aschaWeekPlanVO :AschaWeekPlanVO(
			//			aschaWeekPlanCode=75810922024001902, aschaWeek=1주, aschaWeekPlanCn=a, aschaCode=758109220240019)
			log.info("aschaWeekPlanVO ->aschaWeekPlanVO :" + aschaWeekPlanVO);
			
			aschaWeekPlanVOList2.add(aschaWeekPlanVO);
		}
		/*
		 aschaWeekPlanVO -> aschaWeekPlanVOList2 : [
		 	AschaWeekPlanVO(aschaWeekPlanCode=75810922024001902, aschaWeek=1주, aschaWeekPlanCn=a, aschaCode=758109220240019), 
		 	AschaWeekPlanVO(aschaWeekPlanCode=75810922024001903, aschaWeek=2주, aschaWeekPlanCn=b, aschaCode=758109220240019), 
		 	AschaWeekPlanVO(aschaWeekPlanCode=75810922024001904, aschaWeek=3주, aschaWeekPlanCn=c, aschaCode=758109220240019), 
		 	AschaWeekPlanVO(aschaWeekPlanCode=75810922024001905, aschaWeek=4주, aschaWeekPlanCn=d, aschaCode=758109220240019)]
		 */
		log.info("aschaWeekPlanVO -> aschaWeekPlanVOList2 : "+aschaWeekPlanVOList2);
		
		result += this.afterSchoolMapper.createWeekPlan(aschaWeekPlanVOList2);
		
		return result;
	}

	// 방과후학교 수정
	@Override
	public int afterSchoolUpdate(AschaVO aschaVO) {
		return this.afterSchoolMapper.afterSchoolUpdate(aschaVO);
	}

	// 방과후학교 삭제
	@Override
	public int afterSchoolDelete(AschaVO aschaVO) {
		return this.afterSchoolMapper.afterSchoolDelete(aschaVO);
	}

	// 교사의 방과후화면 개설 목록
	@Override
	public List<AschaVO> afterSchoolTeacherList(String mberId) {
		return this.afterSchoolMapper.afterSchoolTeacherList(mberId);
	}

	// 과목당 수강중인 학생들
	@Override
	public List<AschaVO> lectureStudentList(AschaVO aschaVO) {
		return this.afterSchoolMapper.lectureStudentList(aschaVO);
	}

	// 수강신청 상태 변경
	@Override
	public int lectureStateUpdate(AschaVO aschaVO) {
		return this.afterSchoolMapper.lectureStateUpdate(aschaVO);
	}

	// 학생이 수강신청한 방과후학교 목록
	@Override
	public List<AschaVO> afterSchoolLectureList(String mberId) {
		return this.afterSchoolMapper.afterSchoolLectureList(mberId);
	}

}
