<%@page import="kr.or.ddit.vo.HrtchrVO"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>


<style>
#profileImg{
   width: 120px; height: 120px;
   border-radius: 70%;
   object-fit: cover;
}
/* footer 위치 조절 */
/* .analytics-sparkle-area{ */
/* 	height: 1200px; */
/* } */

.content{
	display: flex;
    justify-content: center;
    align-items: center;
}

.single-product-text {
    padding: 5px;
}
.overflow-scroll {
	height: 270px;
    overflow-y: auto; /* 세로 스크롤 설정 */
}

.class-container{
	margin : 8px 0px;
	height: 360px;
	border: 1px dashed lightgray;
	border-radius: 15px;
	background-color: white;
}

.d-btn-blue {
	height : 30px;
	width : 100%;
	display: inline-block;
}

#center-container{
	padding : 15px 0px;
	height : 100%; 
	display : flex; 
	vertical-align: middle; 
	text-align: justify;"
}

.center-btn {
	font-size: 1.2rem;
	display:inline-block;
	margin: 0px 8px;
	height : 100%;
}

</style>
<script type="text/javascript" src="/resources/js/jquery.min.js" ></script>
<script type="text/javascript">
// 새창에서 채팅창 여는 함수
function openChatPop(url) {
    window.open(url, '_blank'
    		, 'top=140, left=0, width=500, height=1000, menubar=no, toolbar=no, location=no, directories=no, status=no, scrollbars=no, copyhistory=no, resizable=no');
}

// 학생 목록
const getStdList = function(){
	$.ajax({
		url:"/class/getStdList",
		method:"post",
		data:JSON.stringify({"clasCode":'${CLASS_INFO.clasCode}'}),
		contentType: "application/json; charset=utf-8",
		dataType:"json",
		beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		},
		success :function(res){
// 			console.log("getStdList res:",res);
			
			str ="";
			res.forEach(function(std){
				str += `<tr>
						<td>\${std.clasInNo}</td>
						<td>\${std.memberVO.mberNm}</td>
						<td>\${std.memberVO.ihidnum}</td>
						<td>\${std.memberVO.moblphonNo}</td>
						<td>\${std.memberVO.mberEmail}</td>
						</tr>
						`;
			})
			document.querySelector("#stdListTb tbody").innerHTML = str;
			
		},error:function(request, status, error){
			console.log("code: " + request.status)
	        console.log("message: " + request.responseText)
	        console.log("error: " + error);
		}
	})
}

// 과제 목럭 
const getTaskList = function(){
	$.ajax({
		url:"/class/getTaskList",
		method:"post",
		data:JSON.stringify({"clasCode":'${CLASS_INFO.clasCode}',
			"size":"20"}),
		contentType: "application/json; charset=utf-8",
		dataType:"json",
		beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		},
		success :function(res){
// 			console.log("getTaskList res:",res);
			
			str = "";
			res.forEach(function(task){
				str += `<tr class = "d-tr" onclick = "goToTask('\${task.taskCode}')">
						<td>\${cutStr(task.taskSj,30)}</td>
						<td>\${dateToMinFormat(task.taskBeginDt)}</td>
						<td>\${dateToMinFormat(task.taskEndDt)}</td>
						</tr>`;
			})
			
			document.querySelector("#taskListTb tbody").innerHTML = str;
			
		},error:function(request, status, error){
			console.log("code: " + request.status)
	        console.log("message: " + request.responseText)
	        console.log("error: " + error);
		}
	});
}

//알림장 목럭 
const getNtcnList = function(){
	$.ajax({
		url:"/class/getNtcnList",
		method:"post",
		data:JSON.stringify({"clasCode":'${CLASS_INFO.clasCode}',
			"size":"20"}),
		contentType: "application/json; charset=utf-8",
		dataType:"json",
		beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		},
		success :function(res){
			console.log("getNtcnList res:",res);
			
			str = "";
			res.forEach(function(nt){
				str += `<tr class = "d-tr" onclick = "goToNt('\${nt.ntcnCode}')">
						<td>\${cutStr(nt.ntcnSj,40)}</td>
						<td>\${dateToMinFormat(nt.ntcnWritngDt)}</td>`;
				
				if(nt.imprtcNtcnAt == 1){
					str += `<td>중요</td></tr>`;
				}else{
					str += `<td></td></tr>`;
				}
			})
			
			document.querySelector("#ntcnListTb tbody").innerHTML = str;
			
		},error:function(request, status, error){
			console.log("code: " + request.status)
	        console.log("message: " + request.responseText)
	        console.log("error: " + error);
		}
	});
}

// 출결 처리 버튼
const atendBtn = function(){
	cjh.swConfirm("출결", "출결 처리를 진행하시겠습니까?", "question").then(function(res){
		if(res.isConfirmed){
			$.ajax({
				url:"/dclz/insertStdDclz",
				method:"post",
				dataType:"json",
				beforeSend:function(xhr){
					xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
				},
				success:function(res){
					if(res>0){
						cjh.swAlert("완료", "출결 처리가 완료되었습니다.");
					}else{
						cjh.swAlert("실패", "출결 처리에 실패했습니다.", "error");
					}
				}
			})
		}
	})
}

// 과제 테이블에서 게시물 클릭
const goToTask = function(taskCode){
	console.log("goToTask act:", taskCode);
}

// 과제 테이블에서 게시물 클릭
const goToNt = function(ntcnCode){
	console.log("goToNt act:", ntcnCode);
}

window.onload = function() {
	
	getStdList();
	getTaskList();
	getNtcnList();
	
	var mberImage = "${hrtchrVO.memberVO.mberImage}";
	var mberNm = "${hrtchrVO.memberVO.mberNm}";
	var moblphonNo = "${hrtchrVO.memberVO.moblphonNo}";
	var mberEmail = "${hrtchrVO.memberVO.mberEmail}";
// 	alert(mberImage);
	
	var profileImg = document.getElementById("profileImg");
	profileImg.setAttribute("src", "/upload/profile/" + mberImage);
	
	var clasCode = '${clasCode}';
	
// 	document.getElementById("goToTaskList").addEventListener("click", () => {
// 		location.href = "/task/taskList?clasCode=" + "${clasCode}";
// 	});

	//선생님과 채팅하기
	var teacherChatBtn = '${USER_INFO.vwMemberAuthVOList[0].cmmnDetailCode eq 'ROLE_A01003' }';
	console.log("teacherChatBtn : ",teacherChatBtn);
	var familyChatBtn = '${USER_INFO.vwMemberAuthVOList[0].cmmnDetailCode eq 'ROLE_A01002' || USER_INFO.vwMemberAuthVOList[1].cmmnDetailCode eq 'ROLE_A01002' }';
	console.log("familyChatBtn : ",familyChatBtn);

	if(teacherChatBtn === "true"){
		document.querySelector('#teacherChatBtn').addEventListener('click', function () {
			console.log("체크");
			let myId = '${USER_INFO.mberId}';
			console.log("발신자아이디 : "+myId);
		
			let teacherId = '${hrtchrVO.mberId}'
			console.log("수신자아이디 : "+teacherId);
		
			let schulCode = '${hrtchrVO.clasVO.schulCode}';
			console.log("학교코드 : " + schulCode);
		
			let data = {
					"crtrId":teacherId,
		   			"prtcpntId":myId
				}
				
			console.log("data@@!!",data);
		
			$.ajax({
			 	url: '/chat/roomCode',
		           type: 'post',
		           data: JSON.stringify(data),
		           contentType: 'application/json;charset=utf-8',
		           dataType: 'text',
		           beforeSend: function (xhr) {
		               xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
		           },
		           success: function (result) {
		          	console.log("@생성한 채팅방 코드@",result);
		          	console.log("@생성한 채팅방 코드길이@",result.length);
		          	//result가 있으면 내가 생성한 방이 있으므로 생성된 방으로 이동
		          	if(result !='' && result != null){
		         		console.log("생성된 방으로 이동");
		         		openChatPop("/chat/chtt?chttRoomCode="+result);
		          		//location.href = "/chat/chtt?chttRoomCode="+result;
		         	}
		          	 //result가 없으면 내가 초대 받은 방이 있는지확인 
		          	 else{
		          		 let data = {
		        			"crtrId":myId,
		            		"prtcpntId":teacherId	 
		          		 }
		          		 
		          		$.ajax({
		         			 url: '/chat/roomCode',
		                      type: 'post',
		                      data: JSON.stringify(data),
		                      contentType: 'application/json;charset=utf-8',
		                      dataType: 'text',
		                      beforeSend: function (xhr) {
		                          xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
		                      },
		                      success: function (result) {
		                     	 console.log("@초대 받은 채팅방 코드@",result);
		                     	//result가 있으면 내가 초대 받은 방이 있으므로 초대 받은 방으로 이동
		                       if(result != '' && result != null){
		                      		console.log("초대 받은 방으로 이동");
		                      		openChatPop("/chat/chtt?chttRoomCode="+result);
		                      		//location.href = "/chat/chtt?chttRoomCode="+result;
		                      	}
		                     	 //result가 0이면 채팅방 생성
		                     	 else{
		                     		let data = {
		                       			"type":"room",
		                       			"schulCode":"",
		                       			"clasCode":clasCode,
		                       			"crtrId":teacherId,
		                       			"prtcpntId":myId
		                       		}
		                       		
		                       		console.log("data:", data);
		                       		
		                       		$.ajax({
		                       			 url: '/chat/room',
		                                    type: 'post',
		                                    data: JSON.stringify(data),
		                                    contentType: 'application/json;charset=utf-8',
		                                    dataType: 'json',
		                                    beforeSend: function (xhr) {
		                                        xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
		                                    },
		                                    success: function (result) {
		                                   	 console.log("1?",result);
		                                   	 
		                                   	 $.ajax({
		                                 			 url: '/chat/roomCode',
		                                              type: 'post',
		                                              data: JSON.stringify(data),
		                                              contentType: 'application/json;charset=utf-8',
		                                              dataType: 'text',
		                                              beforeSend: function (xhr) {
		                                                  xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
		                                              },
		                                              success: function (result) {
		                                           	   console.log("지금 만든 채팅방 코드",result)
		                                           	   //result가 있으면 내가 만든 방이 있으므로 만든 방으로 이동
		                                                  if(result != '' && result != null){
		                                                 		console.log("만든 방으로 이동");
		                                                 		socket.send("room,"+teacherId+","+myId+","+result);
		                                                 			openChatPop("/chat/chtt?chttRoomCode="+result);
		                                                 		//location.href = "/chat/chtt?chttRoomCode="+result;
		                                                 	}
		                                           	   else{
		                                           		   var Toast = Swal.mixin({
		                                           			   toast: true,
		                                      					   position: 'top-end',
		                                      					   showConfirmButton: true,
		                                      					   timer: 3000
		                                      				   });
		                                      				   Toast.fire({
		                                      					   icon:'error',
		                                      					   title:'채팅방 만들기 실패'
		                                      				   });
		                                           		   return;
		                                           	   }
		                                              },
		                                              error:function(xhr){
		                                              	console.log("4",xhr.status);
		                                              } 
		                                        });
		                                   	 
		                                   	 
		                                    },
		                                    error:function(xhr){
		                                    	console.log("3",xhr.status);
		                                    }
		                       		});
		                     	 }
		                     	 
		                      },
		                      error:function(xhr){
		                      	console.log("2",xhr.status);
		                      }
		         			});
		          		 
		          	 }
		          	 
		           },
		           error:function(xhr){
		           	console.log("1",xhr.status);
		           }
			});
		});
	}
	
	if(familyChatBtn === "true"){
		//학부모와 채팅하기
		document.querySelector('#familyChatBtn').addEventListener('click', function () {
			openChatPop('/chat/clasFam?clasCode='+clasCode);
		});
	}
}
</script>

<form id ="dclzForm" action = "/dclz/insertStdDclz" method ="post"></form>

<div class="container-fluid">
    <div class="row content">
        <div class="col-lg-3 col-md-4 col-sm-4 col-xs-12 class-container" style ="">
            <div class="courses-inner res-mg-t-30 table-mg-t-pro-n tb-sm-res-d-n dk-res-t-d-n">
                <div class="courses-title">
                    <h2>담임 선생님 정보</h2>
                    <hr>
                    <div class="profile-img" style="text-align: center;">
                        <img id="profileImg" src="" alt="">
                    </div>
                    <%-- <strong>${hrtchrVO.memberVO.mberNm}</strong> --%>
                </div>
                <div class="single-product-text">
                    <h4><a class="cards-hd-dn" href="#">${hrtchrVO.memberVO.mberNm}</a></h4>
                    <p style = "margin-bottom: 2px" class="ctn-cards">${hrtchrVO.clasVO.schulNm} ${hrtchrVO.clasVO.clasNm}</p>
                    <h5>☎ ${hrtchrVO.memberVO.moblphonNo} ✉ ${hrtchrVO.memberVO.mberEmail}</h5>
                    <c:if test="${USER_INFO.vwMemberAuthVOList[0].cmmnDetailCode eq 'ROLE_A01003' }">
                    	<button type="button" class="d-btn-blue" id="teacherChatBtn">선생님과채팅</button>
                    </c:if>
                    <c:if test="${USER_INFO.vwMemberAuthVOList[0].cmmnDetailCode eq 'ROLE_A01002' || USER_INFO.vwMemberAuthVOList[1].cmmnDetailCode eq 'ROLE_A01002' }">
                    	<button type="button" class="d-btn-blue" id="familyChatBtn">학부모와채팅</button>
                    </c:if>
                </div>
            </div>
        </div>
        <div class="col-lg-7 col-md-6 col-sm-6 col-xs-12 class-container" style ="width :margin-right : 0px;">
            <div class="courses-inner res-mg-t-30 table-mg-t-pro-n tb-sm-res-d-n dk-res-t-d-n">
                <div class="courses-title">
                    <h2>학생 리스트</h2>
                    <hr>
                </div>
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="padding: 0px;">
                    <div class="product-status-wrap drp-lst overflow-scroll" style="padding: 0px;">
                        <table id = "stdListTb">
                        	<thead>
                                <tr>
                              <th>학급번호</th>
                              <th>이름</th>
                              <th>성별</th>
                              <th>전화번호</th>
                              <th>이메일</th>
                                </tr>
                        	</thead>
                            <tbody>
                                <tr>
						<td colspan="100%" style="text-align: center;">학생이 없습니다..</td>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<sec:authorize access ="hasRole('A01001')">
<div class="container-fluid">
	<div class="row content">
		<div class="col-lg-10 col-md-10 col-sm-10 col-xs-12 class-container" style ="height:80px; width :margin-right : 0px;">
			<div id ="center-container">
				<button onclick = "atendBtn()" class ="d-btn-blue center-btn"style ="width: 40%;">오늘 출석하기</button>
				<button onclick ="location.href ='/unitTest/list'" class ="d-btn-blue center-btn" style = "width:30%">단원평가 실행</button>
				<button class ="d-btn-blue center-btn" style = "width:30%; width :margin-right : 0px;">일기장</button>
			</div>
		</div>
	</div>
</div>
</sec:authorize>

<div class="container-fluid ">
	<div class="row content">
		<div class="col-lg-5 col-md-4 col-sm-4 col-xs-12 class-container">
			<div
				class="courses-inner res-mg-t-30 table-mg-t-pro-n tb-sm-res-d-n dk-res-t-d-n">
				<div class="courses-title">
					<a class="follow-cards" href="/ntcn/ntcnList?clasCode=${clasCode}"
						id="goToNoticeList" style="position: absolute; right: 33px;">➤바로 가기</a>
					<h2>알림장</h2>
					<hr>
				</div>
				<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
					style="padding: 0px;">
					<div class="product-status-wrap drp-lst overflow-scroll"
						style="padding: 0px;">
						<table id = "ntcnListTb">
							<thead>
								<tr>
									<th>제목</th>
									<th>작성 일시</th>
									<th>비고</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="100%" style="text-align: center;">등록된 알림장이 없습니다..</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
		<div class="col-lg-5 col-md-6 col-sm-6 col-xs-12 class-container" style ="width :margin-right : 0px;">
			<div
				class="courses-inner res-mg-t-30 table-mg-t-pro-n tb-sm-res-d-n dk-res-t-d-n">
				<div class="courses-title">
					<div>
						<a class="follow-cards" href="/task/taskList?clasCode=${clasCode}"
							id="goToTaskList" style="position: absolute; right: 33px;">➤
							바로 가기</a>
						<h2>과제 게시판</h2>
						<hr>
					</div>
					<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
						style="padding: 0px;">
						<div class="product-status-wrap drp-lst overflow-scroll"
							style="padding: 0px;">
							<table id="taskListTb">
								<thead>
									<tr>
										<th>과제 제목</th>
										<th>시작 일시</th>
										<th>종료 일시</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td colspan="100%" style="text-align: center;">등록된 과제가 없습니다..</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
