<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<script type="text/javascript">
window.onload = function() {
   document.getElementById("btnList").addEventListener("click",()=>{
      location.href = "/gallery/gallery?clasCode=" + "${clasCode}";
   })
}

$(function(){
	//날짜 포맷 생성  함수
	function dateFormat(date) {
		let dateFormat2 = date.getFullYear() +
		'-' + ( (date.getMonth()+1) < 9 ? "0" + (date.getMonth()+1) : (date.getMonth()+1) )+
		'-' + ( (date.getDate()) < 9 ? "0" + (date.getDate()) : (date.getDate()) );
		return dateFormat2;
	}
	
	$("#atchFileDe").val(dateFormat(new Date()));	// 파일 등록 일자
	$("#updtDe").val(dateFormat(new Date()));		// 수정 일자
	// 날짜 함수 끝~
	
	// 모달창 닫기 시작
	$('#btnUpdateCancel').on("click",function(){
		$(".modal").modal("hide");
	});
	
	// 모달창 닫을때 초기화 하기
	$('.modal').on('hidden.bs.modal', function (e) {
		console.log('modal close');
		// 사진 추가 부분 초기화
		$(this).find('#atchFileNm').val('');		// 파일 이름 초기화
		$(this).find('input[type=file]').val('');	// 파일 초기화
		$(this).find('#divImage').html('');			// 이미지 미리보기 초기화
		
		// 수정 부분 초기화
		$(this).find('#atchFileNmModify').val('').hide();	// 수정 제목 초기화
		$(this).find('#btnModify, #btnDelete').show();		// 수정, 삭제 버튼 보이기
		$(this).find('.PicTitle').val('').show();			// 기존 제목 보이기
		$(this).find('#confirm, #cancel').hide(); 			// 확인, 취소 버튼 숨기기
		$(this).find('#modifyForm').hide();					// 수정 폼 버튼 숨기기
		
	}); // 모달창 닫기 끝

	// 수정 버튼 클릭시 기존제목을 가져와서 input요소에 설정함.
	$("#btnModify").on("click", function(){
//         var existingTitle = $(this).closest('.student-img').find("#imgAlbumNm").text();
        $("#albumNmModify").val("${clasAlbumVO.albumNm}");
    });
	
	// 모달창 승인버튼 누를 시 update
	$("#btnUpdate").on("click", function(){
		let pathname = window.location.pathname;
		pathname = "${param.atchFileCode}";//OJ20240101ALB00007
		pathname = pathname.substring(0,10);//OJ20240101
		console.log("pathname :  "  + pathname);
		
		let clasCode = "<%=request.getParameter("clasCode") %>";
		let atchFileCode = "${param.atchFileCode}";
		let albumNm = "${clasAlbumVO.albumNm}";	// 사진 제목
		let albumDe = $("#albumUpdtDe").val();	// 등록일자
		let inputImgs = $("#inputImgs")[0];	// 파일
		
		console.log("albumNm : " +  albumNm);
		
		// 이미지 파일 꺼내오기
		let files = inputImgs.files;
		
		// FormData 객체 생성(가상 폼)
		let formData = new FormData();
		formData.append("clasCode",pathname);//OJ20240101
		formData.append("albumNm",albumNm);
		formData.append("albumUpdtDe",dateFormat(new Date()));
		formData.append("inputImgs",inputImgs);
		formData.append("atchFileCode",atchFileCode);//*******앨범 하나 OJ20240101ALB00007
		
		console.log("formData",formData);
		
		// FormData에 각각의 이미지를 넣는다.
		for(let i = 0; i < files.length; i++){
			formData.append('uploadFile',files[i]);
		}		
		
		$.ajax({
			url:"/gallery/updateAlbum",
			processData:false,
			contentType:false,
			data:formData,
			type:"post",
			dataType:"json",
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
			success:function(res){
				//res : ClasAlbumVO
				console.log("insertImages->res: ", res);
				
				let str ="";
				
				//res.atchFileVOList : List<AtchFileVO>
		        $.each(res.atchFileVOList, function(idx, atchFileVO) {
		            str += "<div id='imgList'>";
		            str += "<div>";
		            str += "<div class='student-inner-std res-mg-b-30'>";
		            str += "<div class='student-img'>";
		            str += "<a href='#modalPicture' class='clsPicture'";
		            str += " data-atch-file-code='" + atchFileVO.atchFileCode + "'";
		            str += " data-atch-file-sn='" + atchFileVO.atchFileSn + "'";
		            str += " data-picture-url='" + atchFileVO.atchFileCours + "'";
		            str += " data-picture-name='" + atchFileVO.atchFileNm + "'";
		            str += " data-atch-file-date='" + atchFileVO.atchFileDe + "'";
		            str += " data-album_nm='" + atchFileVO.albumNm + "'";
		            str += " data-registId='" + atchFileVO.registId + "' data-toggle='modal'";
		            str += " data-target='#modalPicture'>";
		            str += "<img src='/upload" + atchFileVO.atchFileCours + "'";
		            str += " class='img-fluid mb-2' alt='white sample'>";
		            str += "</a>";
		            str += "<p id='imgAlbumNm' style='display: none;'>"+atchFileVO.albumNm+"</p>";
		            str += "</div>";
		            str += "</div>";
		            str += "</div>";
		            str += "</div>";
		        });
				
		        console.log("str : " + str);
			        $('.asset-inner').html(str);
			        $('.modal').modal('hide');
			}
		});//end ajax		
	});	
 
   // 이미지 미리보기 시작
   $("#inputImgs").on("change", handleImg);
   
   // e : onchange 이벤트 객체
   function handleImg(e){
      
      let files = e.target.files;
      
      let fileArr = Array.prototype.slice.call(files);
   
      fileArr.forEach(function(f){
         // 이미지 파일이 아닌 경우
         if(!f.type.match("image.*")){
            alert("이미지 확장자만 가능합니다"); 
            return;
         }
         // 이미지를 읽기
         let reader = new FileReader();
         
         $("#divImage").html("");
         
         reader.onload = function(e){
            $(".divImage").css({"background-image":"url("+e.target.result+")","background-position":"center","background-size":"cover"});
            let img = "<img src="+e.target.result+" style='width:20%;' />";
            $("#divImage").append(img); 
         }
         reader.readAsDataURL(f);
      });
   } // 이미지 미리보기 끝	
	
	
	// deleteAll 버튼 클릭시 앨범 전체 삭제하기
	$("#btnDeleteAll").on("click",function(){
		
		// url 주소에서 atchFileCode만 추출 
		let atchFileCode = window.location.search.split('=')[1];
		console.log("atchFileCode: " + atchFileCode);
		
		let clasCode = atchFileCode.split('ALB')[0];
		console.log("clasCode: " + clasCode);
		
		let confirmd = confirm("정말 삭제하시겠습니까?");
		if(confirmd){
			let formData = new FormData();
			formData.append("atchFileCode",atchFileCode);
			
			console.log("formData",formData);
			
			$.ajax({
				url : "/gallery/deleteAlbum",
				contentType : false,
				processData : false,
				data : formData,
				type : "post",
				dataType : "text",
				beforeSend:function(xhr){
		            xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		        },
		        success: function(result) {
	                console.log("result : ", result);
	                if (result != "0") {
	                    console.log("삭제처리");
	                    // 목록으로 돌아가기로 수정하기
						window.location.href = "http://localhost/gallery/"+clasCode;
							alert("삭제 완료 되었습니다");
	                } else{
							alert("삭제 실패 하였습니다");
					
						}
	            },
				error : function(xhr,status,error){
					console.error("에러발생 :", error);
					alert("삭제중 오류가 발생했습니다.");
				}

			});
		}else{
			console.log("삭제 취소");
		}

	}); // 앨범 전체삭제 끝
   
   // 갤러리 상세
   // param :  atchFileCode=OJ20240101ALB00003
   $.ajax({
       url: "/gallery/galleryDetailAjax",
       contentType: "application/json;charset=utf-8",
       data: {
           atchFileCode: "${param.atchFileCode}"
       },
       type: "get",
       dataType: "json",
       success: function(res) {
           console.log("res : ", res);
   
           var carouselItems = "";
   
           $.each(res, function(idx, atchFileVO) {
               carouselItems += "<div class='carousel-item'>";
               carouselItems += "<img src='/upload" + atchFileVO.atchFileCours + "' class='d-block w-100' alt='" + atchFileVO.atchFileNm + "'>";
               carouselItems += "</div>";
           });
   
           // 캐러셀에 이미지 추가
           $('.carousel-inner').html(carouselItems);
           $('.carousel-item').first().addClass('active');
           // 캐러셀 컨트롤러에 속성 설정
           $('#carouselExampleControls').removeAttr('data-bs-ride');
           
       }
   });
   
	// 수정버튼 클릭 시 일반모드/ 수정모드 토글
	$("#btnModify").on("click", function(){
  	    // 기존 제목을 가져와서 input 요소에 설정함.
  	    var existingTitle = $("").text();
  	    $("#atchFileNmModify").val(existingTitle);
  	    $("#PicTitle").css("display","none");
  	    $("#atchFileNmModify").css("display","block");
  	    $("#albumUpdtDe").val(dateFormat(new Date()));
	});

   // 이미지 클릭 시 해당 이미지 모달
  $(".clsPicture").on("click", function() {
	    let atchFileCours = $(this).data("data-picture-url");
	    console.log("atchFileCours : " + atchFileCours);

	    let atchFileNm = $(this).data("data-picture-name");
	    console.log("atchFileNm : " + atchFileNm);
	    
	    // 이미지 모달 창의 제목 업데이트
	    $("#PicTitle").text(atchFileNm);

	    let atchFileSn = $(this).data("atch-file-sn");
	    let atchFileCode = $(this).data("atch-file-code");

	    $(".btn").data("atch-file-sn", atchFileSn);
	    $(".btn").data("atch-file-code", atchFileCode);
	    $(".btn").data("atch-picture-url", atchFileCours);
	    $(".btn").data("atch-picture-name", atchFileNm);
	    $(".btn").data("atch-file-date", atchFileDe);
	    $(".btn").data("atch-registId", registId);

	    $(".modalPicBody > p").html("<img src='/resources/upload" + atchFileCours + "' style='width:200%;' />");
	}); // 모달창 끝

});

</script>
<style>
/* 갤러리 출력 설정 */

.container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-gap: 20px; /* 그리드 아이템 사이의 간격 설정 */
    width: 100%; /* 컨테이너의 너비를 화면에 맞게 조정 */
    padding: 20px; /* 컨테이너 주위의 안쪽 여백 설정 */
    box-sizing: border-box; /* 안쪽 여백이 너비에 포함되도록 상자 크기 지정 */
}
img.profile-image {
   width: 80px;
   border-radius: 50%;
}

.image_header {
   padding: 10px;
   display: flex;
}

div#imageInfo {
   display: inline-grid;
}

.image_main {
   text-align: center;
}

.gallery {
   width: 800px;
   height: 800px;
}

img {
   border-style: none;
   width: 600px;
}

.image_footer {
   height: 50px;
   display: inline;
   text-align: center;
}
</style>
<p>${ClasAlbumVO}</p>
<div class="sparkline8-list">
   <div class="gallery">
      <div class="image_header">
         <div>
            <img class="profile-image"
               src="/upload/2024/03/15/a0fefe8e-eab3-4f49-8581-25cc5ecf9e0a_강초록(미완성).png" />
         </div>
         <div id="imageInfo">
            <div>
               <label for="">제목</label> <label for="">${clasAlbumVO.albumNm}</label>
            </div>
            <div>
  	          <label for="">작성자</label>
  	          <p><p>
            </div>
            <div>
  	          <label for="">작성일자</label>
            </div>

         </div>
         <div>${clasAlbumVO.albumNm}</div>
      </div>

      <div class="image_main">
         <!-- 캐러샐 적용 시작 -->
         <div id="carouselExampleControls" class="carousel slide"
            data-bs-ride="carousel">
            <div class="carousel-inner">
               <div class="carousel-item active">
                  <img src="..." class="d-block w-100" alt="...">
               </div>
               <div class="carousel-item">
                  <img src="..." class="d-block w-100" alt="...">
               </div>
               <div class="carousel-item">
                  <img src="..." class="d-block w-100" alt="...">
               </div>
            </div>
            <button class="carousel-control-prev" type="button"
               data-bs-target="#carouselExampleControls" data-bs-slide="prev">
               <span class="carousel-control-prev-icon" aria-hidden="true"></span>
               <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button"
               data-bs-target="#carouselExampleControls" data-bs-slide="next">
               <span class="carousel-control-next-icon" aria-hidden="true"></span>
               <span class="visually-hidden">Next</span>
            </button>
         </div>
         <!-- 캐러샐 적용 끝 -->
      </div>

      <div class="#">
         <div id="hashTagList">해시태그</div>
         <div class="image_footer">
            <div>
               <button type="button" id="btnModify"
                  class="btn btn-custon-rounded-four btn-primary"
                  data-toggle="modal" data-target="#modalUpdate">수정</button>
               <button type="button" id="btnDeleteAll"
                  class="btn btn-custon-rounded-two btn-danger">전체 삭제</button>
               <button id="btnList" class="btn btn-custon-rounded-two btn-default">파일
                  목록</button>
            </div>
         </div>
      </div>
   </div>
</div>

<!-- 앨범 수정 -->
<div id="modalUpdate" class="modal modal-edu-general default-popup-PrimaryModal fade in" role="dialog" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-color-modal bg-color-1">
                <div class="modal-close-area modal-close-df">
                    <a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
                </div>
            </div>
            <div class="modal-body">
                
                <h2>앨범 수정</h2>
                <div class="form-group">
                   <label for="">앨범 이름</label>
                  <input type="text" class="form-control is-valid" id="albumNmModify" name="albumNm" 
                  value="${clasAlbumVO.albumNm}" placeholder="앨범 이름" />
            </div>
               
                <div class="form-group">
                   <label for="">앨범 수정 날짜</label>
                   <input type="text" name="" class="form-control" id="albumUpdtDe" name="albumUpdtDe"
                   placeholder="현재날짜 표시" required readonly/>
                </div>
            <div class="form-group">
               <label for="">사진 첨부</label>
                   <input type="file" class="form-control" id="inputImgs" multiple>
            </div>
         </div>
            <div id="divImage">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-custon-rounded-four btn-primary" id="btnUpdate">수정</button>
               <button type="button" class="btn btn-custon-rounded-four btn-danger" id="btnUpdateCancel">수정 취소</button>
            </div>
        </div>
    </div>
</div>
