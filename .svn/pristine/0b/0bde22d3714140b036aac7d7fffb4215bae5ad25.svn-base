<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<script type="text/javascript">
//beforeSend 전역변수 처리
const header="${_csrf.headerName}";
const token ="${_csrf.token}";

window.onload = function(){
	console.log("window.onload 실행되었습니다~");
	// 목록 불러오기
	loadAfterSchoolList();
	
	// 방과후버튼 클릭시 생성화면으로 이동하기
	document.querySelector("#addAfterSchool").addEventListener("click", ()=>{
		location.href = "/afterSchool/afterSchoolCreate?schulCode="+"${param.schulCode}";
	});

	//날짜 포맷 생성  함수
	function dateFormat(date) {
		let dateFormat2 = date.getFullYear() +
		'-' + ( (date.getMonth()+1) < 9 ? "0" + (date.getMonth()+1) : (date.getMonth()+1) )+
		'-' + ( (date.getDate()) < 9 ? "0" + (date.getDate()) : (date.getDate()) );
		return dateFormat2;
	}
	
	
	function loadAfterSchoolList(){
		let currentPage = "${param.currentPage}";
		if(currentPage =="") currentPage ="1";

// 		keyword = document.getElementById("keyword").value;
		
		let data = {
			"currentPage" : currentPage,	
			"keyword" 	  : "",
			"schulCode"	  : "${param.schulCode}"
		};
		
		console.log("data : ",data);
		
		// 방과후 학교 목록 검색
		$.ajax({
			url: "/afterSchool/afterSchoolList",
			contentType : "application/json; charset= utf-8",
			data: JSON.stringify(data),
			type : "post",
			dataType : "json",
			beforeSend : function(xhr){
				xhr.setRequestHeader(header, token);
			},
			success : function(result){
				// result : ArticlePage<AschaVO>
				console.log("result : ", result);
				let str = "";
				result.content.forEach(function(aschaVO, idx){
					let aschaAtnlcBgnde = dateFormat(new Date(aschaVO.aschaAtnlcBgnde));
					let aschaAtnlcEndde = dateFormat(new Date(aschaVO.aschaAtnlcEndde));
					
					str += `
						<tr>
						<td>\${idx+1}</td>
						<td>\${aschaVO.aschaNm}</td>	
						<td>\${aschaVO.aschaAceptncPsncpa}</td>
						<td>\${aschaAtnlcBgnde}</td>
						<td>\${aschaAtnlcEndde}</td>
						<td>\${aschaVO.mberNm}</td>
						<td>
							<button class="pd-setting btnDetail" data-toggle="modal" data-aschaCode="\${aschaVO.aschaCode}" data-target="#afterSchoolDetail">상세보기</button>
							<button class="pd-setting btnUpdate" data-aschaCode="\${aschaVO.aschaCode}">수정하기</button>
						</td>
					</tr>`;
				});
				document.querySelector("#listBody").innerHTML = str;
				document.getElementById("divPaging").innerHTML=result.pagingArea;
				console.log("str:",str);
				
				// 수정 버튼 클릭시 수정화면으로 이동하기
				document.querySelectorAll(".btnUpdate").forEach(function(btn){
						btn.addEventListener("click", ()=>{
							let aschaCode = event.target.getAttribute("data-aschaCode");
							console.log("aschaCode :",aschaCode);
			 				location.href = "/afterSchool/afterSchoolUpdate?aschaCode="+aschaCode+"&schulCode="+"${param.schulCode}";
					});
				});
			}
		});
	}
	
	   // 상세보기 모달
		$(document).on("click",".btnDetail",function(){
			console.log("상세보기 모달입니다");
			
			var aschaCode = $(this).attr("data-aschaCode");
			console.log("aschaCode :",aschaCode);
			
			let data = {
					"schulCode" : "${param.schulCode}",
					"aschaCode"	: aschaCode
			}
			console.log("data : ",data);
			
			$.ajax({
				url:"/afterSchool/afterSchoolDetail",
				contentType: "application/json; charset=utf-8",
				data: JSON.stringify(data),
				type: "post",
				dataType:"json",
				beforeSend : function(xhr){
					xhr.setRequestHeader(header, token);
				},
				success : function(result){
					console.log("result: ", result);
					let aschaAtnlcBgnde = dateFormat(new Date(result.aschaAtnlcBgnde));
					let aschaAtnlcEndde = dateFormat(new Date(result.aschaAtnlcEndde));
					
					
					$("#aschaNm").text(result.aschaNm);
					$("#mberNm").text(result.mberNm);
					$("#aschaAtnlcBgnde").text(aschaAtnlcBgnde);
					$("#aschaAtnlcEndde").text(aschaAtnlcEndde);
					$("#aschaDetailCn").text(result.aschaDetailCn);
					$("#aschaAtnlcCt").text(result.aschaAtnlcCt);
					
				}
					
			});
		
		});
}

</script>
<style>
button.pd-setting.btnUpdate {
    background: #df3c3c;
}
</style>

<!-- 방과후학교 목록 검색 -->
<div class="container-fluid">
	<div class="row">
		<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
			<div class="breadcome-list single-page-breadcome">
				<h1>방과후학교 목록</h1>
				<p>${aschaVO.aschaNm}</p>
				<div class="row">
					<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
						<div class="breadcome-heading">
							<form role="search" class="sr-input-func">
								<input type="text" placeholder="방과후학교 검색"
									class="search-int form-control"> <a href="#"><i
									class="fa fa-search"></i></a>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 방과후학교 목록 검색 끝 -->
<!-- 방과후학교 목록 -->
<div class="product-status mg-b-15">
	<div class="container-fluid">
		<div class="row">
			<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
				<div class="product-status-wrap drp-lst">
					<h4>개설과목( 건)</h4>
<!-- 					<div class="add-product"> -->
<!-- 						<a href="/afterSchool/afterSchoolCreate">방과후학교 관리(선생님)</a> -->
<!-- 					</div> -->
					<!-- 방과후학교 생성 -->
					<div>
						<button type="button" id="addAfterSchool" class="btn btn-custon-rounded-four btn-primary">방과후학교 생성</button>
					</div>
					<div class="asset-inner">
						<table>
							<thead>
								<tr>
									<th>번호</th>
									<th>방과후학교 명</th>
									<th>수용정원(명)</th>
									<th>수강시작일자</th>
									<th>수강종료일자</th>
<!-- 									<th>요일</th> -->
									<th>담당선생님</th>
									<th>상세정보</th>
								</tr>
							</thead>

							<tbody id="listBody">
							</tbody>
						</table>
					</div>
					<div>
						<div class="pull-right pagination" id="divPaging"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 방과후학교 상세보기 모달 -->
<div id="afterSchoolDetail"
	class="modal modal-edu-general default-popup-PrimaryModal fade in"
	role="dialog" style="display: none;">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header header-color-modal bg-color-1">
				<div class="modal-close-area modal-close-df">
					<a class="close" data-dismiss="modal" href="#"><i
						class="fa fa-close"></i></a>
				</div>
			</div>
			<div class="modal-body">

				<h2 id="aschaNm">방과후학교 명</h2>
				
				<div class="form-group">
					<label for="">담당 선생님</label>
					<div id="mberNm"></div>
				</div>

				<div class="form-group">
					<label for="">수강 기간</label>
					<div>
						<div id="aschaAtnlcBgnde"></div> ~
						<div id="aschaAtnlcEndde"></div>
					</div>
				</div>

				<div class="form-group">
					<label for="">수강 비용</label>
					<div id="aschaAtnlcCt"></div>
				</div>

				<div class="form-group">
					<label for="">강의 설명</label>
					<div id="aschaDetailCn"></div>
				</div>

				<div class="form-group">
					<label for="">나중에 강의계획서도 넣을거에요~</label>
					<div id=""></div>
				</div>

			</div>
			<div class="modal-footer">
				<!-- 학부모 버튼 -->
				<button type="button"
					class="btn btn-custon-rounded-four btn-primary">수강 신청</button>
				<button type="button"
					class="btn btn-custon-rounded-four btn-default">닫기</button>
			</div>
		</div>
	</div>
</div>
<!-- 방과후학교 상세보기 모달 끝-->