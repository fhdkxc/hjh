<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>  
<script type="text/javascript" src="/resources/js/jquery.min.js" ></script> 
<script type="text/javascript" src="/resources/js/commonFunction.js" ></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e03ac7f006917848896c4f551e98f356"></script>

<style>
#schoolMain {
/* 	font-size: 1.2rem; */
max-width :1400px;
min-width :1000px;
margin :auto;
}

.hor-div {
	display: flex;
}
.ver-div {
	display: flex;
	flex-flow: column;
}

#schoolMain h3, #schoolMain h2, #schoolMain h1 {
	display:inline-block;
}

.box {
	background-color: rgb(250, 250, 250);
	border:1px dotted lightgray;
	padding:10px;
	border-radius: 10px;
	width:100%;
	margin:5px;
}
.inner-box {
	background-color: rgb(250, 250, 250);
	border:1px dotted lightgray;
	padding:10px;
	border-radius: 10px;
	width:100%;
	margin-bottom: 10px;
}

img {
	background-size: cover;
	height :auto;
}


#clsContainer {
	display: flex;
	flex-wrap:wrap;
	align-items: flex-start;
	justify-content: flex-start;
}

.cl {
	display:inline-block;
	position:relative;
	margin : 5px;
}

.cl p {
	position:absolute;
	bottom:3px;
	left:8px;
	font-weight: bold;
	margin-bottom: 1px;
}

.clasBtn {
	border: 1px solid #e0e0e0;
	border-radius: 20px; 
	background-color: #f0f0f0;
}

.clasBtn img {
	width:115px;
}

.clasBtn:hover {
	border-color:#dcb24b;
	background-color : #FCC25B;
	transition: all 0.1s ease;
}

#schoolSchedule p {
	margin-bottom: 3px;
}

.headComment { 
	font-size:1.2rem;
	font-weight: bold;
	padding : 10px;
} 

.subHeadComment { 
	font-weight: bold;
	padding : 0px 10px;
} 

.con { 
    overflow: auto; 
    padding :10px; 
    height:80%; 
} 

.grid button {
	width :130px;
	height :130px;
	margin : 5px;
	padding :20px;
	border:1px solid #f0f0f0;
	border-radius: 20px;
	font-size: 1.2rem;
	color:white;
}

.grid button:hover{
	filter: brightness(90%);
	transition: all 0.1s ease;
}

</style>

<script>
// 최초 로그인시 비밀번호 변경 요구
const passwordChange = function(){
    console.log("${USER_INFO}");
    var password = "${USER_INFO.password}";
    
    var defaultPw = "$2a$10$z77PP1RfeUMJJFWY0p47Re2/wajq56UYywuzqGapxbRGMFDMeGZWG";
    var updatePwMsg = "최초 1회 비밀번호 변경이 필요합니다. \n비밀번호를 변경하시겠습니까?";
    
    // 아이디에서 권한 추출하기
    var authStr = "${memberVO.mberId}";
    console.log("authStr: " + authStr);
    var auth = authStr.charAt(7);
    console.log("auth: " + auth);

	var cmmnDetailCode = "";

	if(auth == "0" && password == defaultPw){ // 학생인 경우
		if(confirm(updatePwMsg)){
			location.href = "/student/mypage";
		}
	}
	
	if(auth == "1" && password == defaultPw){ // 선생님인 경우
	    if(confirm(updatePwMsg)){
			location.href = "/teacher/mypage";
		}
	}
}

// 급식 정보
const getMeals = function(){
	$.ajax({
		url:"/school/mainPageMeals",
		method:"post",
		dataType:"json",
		beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		},
		success:function(res){
			console.log(" getMeals res:",res);
			
			let today = res[0];
			let tomorrow = res[1];
			
			console.log("today:",today);
			console.log("tomorrow:",tomorrow);
			
			if(today != null){
				document.querySelector("#todayMeal").innerHTML = `<p>\${today.dietMenu}</p>`;
			}
			if(tomorrow != null){
				document.querySelector("#tomorrowMeal").innerHTML = `<p>\${tomorrow.dietMenu}</p>`;
			}
		}
	})
}

// 가입한 학교 목록
const getClassList = function(){
	$.ajax({
		url:"/school/myClassList",
		method:"post",
		dataType:"json",
		beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		},
		success:function(res){
			let str = "";

			res.forEach(function(item, index){
				str += 	`
						<div class ="cl">
						<button class = "clasBtn" onclick ="enterClass('\${item.clasCode}')"><img src ="/resources/images/member/signUp2.png" alt =""></button>
						`;
				
				<sec:authorize access="hasRole('A01003')">
					str += `<p>[\${item.memberVO.mberId}] \${item.memberVO.mberNm} 자녀의</p>`;
				</sec:authorize>
				
				str +=	`
						<p>\${item.cmmnDetailCodeVO.cmmnDetailCodeNm}학년 \${item.clasNm}반</p>
						</div>
						`;
				
				if(index==5){
					alert("그만.");
				}
			});
			$("#clsContainer").prepend(str);
		},
		error:function(request, status, error){
			console.log("code: " + request.status)
	        console.log("message: " + request.responseText)
	        console.log("error: " + error);
		}
	})
}

// 클릭한 학급클래스 입장
const enterClass = function(clasCode){
	document.querySelector("#clasCode").value=clasCode;
	document.querySelector("#goToClassForm").submit();
}


// 지도 api
const initMap = function(){
	let schNm = "${SCHOOL_INFO.schulNm}";
	let y = 36.450701;
	let x = 127.270667;
	
	$.ajax({
		url:"https://dapi.kakao.com/v2/local/search/keyword.json",
		contentType:"application/json; charset=UTF-8;",
		data:{"query":schNm},
		headers: {"Authorization":"KakaoAK ed3b8c773b19e104fc3ab5f2ce2e548c"},
		method:"get",
		dataType:"json",
		async:false,
		success:function(res){
			console.log("initMap res:",res);
			
			res.documents.forEach(function(item){
				if(item.place_name == schNm){
					x = item.x;
					y = item.y;
					return false;
				}
			})
		}
	})
	
	var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
	var options = { //지도를 생성할 때 필요한 기본 옵션
		center: new kakao.maps.LatLng(y, x), //지도의 중심좌표.
		level: 4 //지도의 레벨(확대, 축소 정도)
	};

	var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
}

window.onload = function(){
	// 최초 로그인시 비밀번호 변경 요구
// 	passwordChange();
	// 급식 정보
	getMeals();
	// 가입한 학교 목록
	getClassList();
	// 지도 api
	initMap();
}
</script>

<form id="goToClassForm" action="/class/classMain" method="post">
	<input type="hidden" id="clasCode" name="clasCode" value="">
	<sec:csrfInput />
</form>

<div id ="schoolMain">

	<div class ="hor-div" style ="height:80px">
		<div class ="box">
			<img src = "/resources/images/member/signUp2.png" style ="width:50px; height:50px">
			<h1 class = "">${SCHOOL_INFO.schulNm}</h1>
		</div>
	</div>
	<div class ="hor-div" style ="height:350px">
		<div class ="box" style="width:33%">
			<div class = "headComment">가입한 반</div>	
			<div id ="clsContainer">
				<div class ="cl">
					<button class ="clasBtn">
						<img src ="/resources/images/common/plus.png" onclick = "location.href ='/school/schoolList'">
						<p>반 가입하기</p>
					</button>
				</div>
			</div>
		</div>
		<div class ="box" style="width:22%">
			<div class = "headComment">급식</div>
			<div class = "ver-div" style ="height:85%;">
				<div class = "inner-box" style="height:50%;">
					<div class="subHeadComment">오늘</div>
					<div id = "todayMeal" class = "con">
						<p>등록된 급식 정보가 없습니다...</p>
					</div>
				</div>
				<div class = "inner-box" style="height:50%;">
					<div class="subHeadComment">내일</div>
					<div id = "tomorrowMeal" class="con">
						<p>등록된 급식 정보가 없습니다...</p>
					</div>
				</div>
			</div>
		</div>
		<div class ="box" style="width:22%">
			<div class = "headComment">학사 일정</div>
			<div id = "schoolSchedule"  class = "con">
				<p>[2024-04-04]<br> 운동회운동회운동회운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회운동회운동회운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
				<p>[2024-04-04]<br> 운동회</p>
			</div>
		</div>
		<div class ="box" style="width:22%">
			<div class = "headComment">바로가기</div>
			<div class = "ver-div grid" style ="height:85%; align-items: center;">
				<div class ="hor-div" style ="height:50%; justify-content: center; align-items:flex-end;">
					<button style ="background-color: #F4C6DC; border-color: #F4C6DC">방과후학교</button>
					<button style ="background-color: #DDAE93; border-color: #cD9E83">급식</button>
				</div>
				<div class ="hor-div" style ="height:50%; justify-content: center; align-items:flex-start; ">
					<button style ="background-color: #C6F4E5; border-color: #b6e4d5">자료실</button>
					<button style ="background-color: #C6D9F4; border-color: #b6c9e4">학사 일정</button>
				</div>
			</div>
		</div>
	</div>
	<div class ="hor-div" style ="height:350px">
		<div class ="box"  style ="width:33%;">
			<div class = "headComment">자료실</div>
		</div>
		<div class ="box"   style ="width:44%;">
			<div class = "headComment">교육부 소식</div>
			<div id = ""  class = "con">
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1 교육부 소식1</p>
				<p>[2024-03-09] 교육부 소식1 교육부 소식1 교육부 소식1 교육부 소식1</p>
			</div>
		</div>
		<div class ="box" style ="width:22%;">
			<div class = "headComment">학교 위치</div>
			<div id="map" style="width:100%;height:80%;"></div>
		</div>
	</div>
	<div style="height:80px"></div>
</div>
